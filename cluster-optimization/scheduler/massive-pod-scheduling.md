---
title: "å¤§è§„æ¨¡Podè°ƒåº¦ä¼˜åŒ–"
weight: 1
catalog: true
date: 2025-06-07 10:50:57
subtitle:
header-img: 
tags:
- Kubernetes
catagories:
- Kubernetes
---

å‡è®¾åœ¨ Kubernetes é›†ç¾¤ä¸­ä¸€æ¬¡æ€§è°ƒåº¦ 1 ä¸‡ä¸ª Podï¼Œ è¿™æ˜¯ä¸€é¡¹æå…·æŒ‘æˆ˜æ€§çš„ä»»åŠ¡ã€‚å¦‚æœç®¡ç†ä¸å½“ï¼Œå¯èƒ½ä¼šå¯¼è‡´è°ƒåº¦å™¨ç“¶é¢ˆã€API Server è¿‡è½½ï¼Œç”šè‡³æ•´ä¸ªé›†ç¾¤å´©æºƒã€‚

æœ¬æ–‡å°†æ¢è®¨ä¼˜åŒ–å¤§è§„æ¨¡ Pod è°ƒåº¦çš„æœ€ä½³å®è·µä¸æŠ€æœ¯æ‰‹æ®µã€‚

---

# ğŸš€ é¢ä¸´çš„æŒ‘æˆ˜

- **è°ƒåº¦å™¨å‹åŠ›å¤§**ï¼šå¤§é‡ Pod åŒæ—¶è¿›å…¥ Pending çŠ¶æ€ï¼Œè°ƒåº¦å™¨å¤„ç†ä¸è¿‡æ¥ã€‚
- **API Server å‹åŠ›å¤§**ï¼šé«˜é¢‘çš„ CREATE/GET/LIST è¯·æ±‚å¯èƒ½è§¦å‘é™æµã€‚
- **etcd å»¶è¿Ÿå¢åŠ **ï¼šå†™å…¥åŠçŠ¶æ€å˜åŒ–é¢‘ç¹ï¼Œå¯¼è‡´å­˜å‚¨åç«¯å‹åŠ›è¿‡å¤§ã€‚
- **èŠ‚ç‚¹å‹åŠ›ä¸å‡è¡¡**ï¼šè°ƒåº¦ä¸å‡å¯å¯¼è‡´éƒ¨åˆ†èŠ‚ç‚¹ CPU/å†…å­˜/ç£ç›˜ IO èµ„æºæ‰“çˆ†ã€‚
- **ç½‘ç»œæ’ä»¶ç“¶é¢ˆ**ï¼šCNI æ’ä»¶æ— æ³•å¤„ç†å¤§é‡å¹¶å‘çš„ IP åˆ†é…ã€‚

---

# 1. è°ƒåº¦å™¨ä¼˜åŒ–

## ğŸ”§ 1.1. æ§åˆ¶ Pod åˆ›å»ºé€Ÿç‡

ä¸è¦ä¸€æ¬¡æ€§å¯åŠ¨ 10,000 ä¸ª Podï¼Œè€Œæ˜¯ï¼š

- **åˆ†æ‰¹åˆ›å»º**ï¼šä¾‹å¦‚æ¯æ‰¹åˆ›å»º 500â€“1000 ä¸ª Podã€‚
- **æ§åˆ¶é€Ÿç‡**ï¼šé€šè¿‡è„šæœ¬æˆ– Job æ§åˆ¶å™¨å¼•å…¥ `sleep` ç­‰æ—¶é—´é—´éš”ã€‚

### ç¤ºä¾‹ Shell è„šæœ¬ï¼š

```bash
for file in batches/batch_*.yaml; do
  kubectl apply -f "$file"
  sleep 10
done
```


## âš™ï¸ 1.2. è°ƒä¼˜é»˜è®¤è°ƒåº¦å™¨

é»˜è®¤è°ƒåº¦å™¨ï¼ˆ`kube-scheduler`ï¼‰åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹å¯èƒ½æˆä¸ºç“¶é¢ˆã€‚ä¸ºäº†é«˜æ•ˆè°ƒåº¦ 1 ä¸‡ä¸ªä»¥ä¸Šçš„ Podï¼Œå¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢è¿›è¡Œæ·±å…¥è°ƒä¼˜ï¼š

### âœ… 1. æé«˜å¹¶å‘è°ƒåº¦èƒ½åŠ›

Kubernetes v1.19+ æ”¯æŒé…ç½®å¹¶è¡Œè°ƒåº¦çº¿ç¨‹æ•°ï¼š

```yaml
apiVersion: kubescheduler.config.k8s.io/v1
kind: KubeSchedulerConfiguration
profiles:
- schedulerName: default-scheduler
  parallelism: 64
```

> æ¨èå€¼ä¸º CPU æ ¸å¿ƒæ•°çš„ 2~4 å€ï¼ˆè§†è°ƒåº¦å¯†é›†åº¦è€Œå®šï¼‰ã€‚  
> æ³¨æ„ï¼šå¹¶å‘è¿‡é«˜å¯èƒ½å¯¼è‡´å†…å­˜æ¿€å¢æˆ– etcd å‹åŠ›è¿‡å¤§ï¼Œå»ºè®®ç»“åˆå‹æµ‹è¯„ä¼°ã€‚

### âœ… 2. å¯ç”¨ç¼“å­˜è°ƒåº¦å™¨ï¼ˆScheduling Queue ä¼˜åŒ–ï¼‰

è°ƒåº¦å™¨å†…éƒ¨ç»´æŠ¤äº† Pending Pod çš„ä¼˜å…ˆé˜Ÿåˆ—ï¼ˆ`PriorityQueue`ï¼‰ä¸ Node ä¿¡æ¯ç¼“å­˜ã€‚

- **ç¡®ä¿ä½¿ç”¨ä¼˜å…ˆçº§è°ƒåº¦**ï¼ˆPodPriorityï¼‰å¯å¸®åŠ©è°ƒåº¦å™¨ä¼˜å…ˆå¤„ç†é‡è¦ä»»åŠ¡ã€‚

- é…ç½®è°ƒåº¦å™¨æ—¶å¯å¯ç”¨ `permit` æ’ä»¶é˜¶æ®µï¼Œåœ¨è°ƒåº¦å†³ç­–å‰æå‰æ§åˆ¶è°ƒåº¦æµé‡ã€‚

### âœ… 3. å…³é—­æˆ–ç²¾ç®€è€—æ—¶æ’ä»¶

æŸäº›é»˜è®¤å¯ç”¨çš„æ’ä»¶åœ¨è°ƒåº¦é«˜å³°æ—¶ä¼šå¸¦æ¥æ€§èƒ½è´Ÿæ‹…ï¼š

| æ’ä»¶               | ç±»å‹     | è¯´æ˜             |
| ---------------- | ------ | -------------- |
| VolumeBinding    | Bind   | æŒä¹…åŒ–å·ç»‘å®šï¼Œéœ€è®¿é—® API |
| NodeResourcesFit | Filter | æ£€æŸ¥èµ„æºæ˜¯å¦æ»¡è¶³       |
| InterPodAffinity | Filter | Pod ä¹‹é—´äº²å’Œæ€§è®¡ç®—å¤æ‚  |

âš ï¸ **ä¼˜åŒ–å»ºè®®**ï¼š

- æ— çŠ¶æ€æœåŠ¡å»ºè®® **å…³é—­ VolumeBinding** æ’ä»¶ã€‚

- åªä½¿ç”¨å¿…è¦çš„ Score æ’ä»¶ï¼ˆå¦‚ `LeastAllocated`ã€`BalancedAllocation`ï¼‰ã€‚

é…ç½®æ–¹å¼ï¼š

```yaml
plugins:
  score:
    disabled:
    - name: "NodeResourcesBalancedAllocation"
    enabled:
    - name: "NodeResourcesLeastAllocated"
```

### âœ… 4. é¢„é€‰èŠ‚ç‚¹é›†èŒƒå›´ï¼ˆèŠ‚ç‚¹å‰ªæï¼‰

è°ƒåº¦å™¨é»˜è®¤ä¼šè¯„ä¼°æ‰€æœ‰å¯è°ƒåº¦èŠ‚ç‚¹ï¼Œ1 ä¸‡ Pod Ã— 1 åƒèŠ‚ç‚¹çš„ç»„åˆæå…¶è€—æ—¶ã€‚

ä¼˜åŒ–æ–¹æ³•ï¼š

- **NodeAffinity**ï¼šæå‰é€šè¿‡æ ‡ç­¾ç­›æ‰ä¸ç¬¦åˆçš„èŠ‚ç‚¹ã€‚

- **ä½¿ç”¨ preFilter æ’ä»¶** è‡ªå®šä¹‰èŠ‚ç‚¹é›†åˆã€‚

ç¤ºä¾‹ï¼š

```yaml
affinity:
  nodeAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      nodeSelectorTerms:
      - matchExpressions:
        - key: node-role.kubernetes.io/worker
          operator: In
          values:
          - batch
```


### âœ… 5. å¯ç”¨æ‹“æ‰‘æ„ŸçŸ¥ä¸äº²å’Œæ€§ç¼“å­˜

ä½¿ç”¨æ‹“æ‰‘è°ƒåº¦å»ºè®®ï¼š

```yaml
topologySpreadConstraints:
- maxSkew: 1
  topologyKey: topology.kubernetes.io/zone
  whenUnsatisfiable: ScheduleAnyway
```


### âœ… 6. æ§åˆ¶è°ƒåº¦é˜Ÿåˆ—å‹åŠ›ï¼ˆBackoff & Retryï¼‰

Pod å¤šæ¬¡è°ƒåº¦å¤±è´¥ä¼šè¿›å…¥ backoff é˜Ÿåˆ—ï¼Œé»˜è®¤é€€é¿æ—¶é—´ä¸ºï¼š

```go
InitialBackoff = 1 * time.Second 
MaxBackoff = 10 * time.Second
```

è°ƒå¤§ `MaxBackoff` å¯å‡ç¼“é«˜é¢‘é‡è¯•å¯¹è°ƒåº¦å™¨çš„å‹åŠ›ã€‚

### ğŸ§ª è°ƒä¼˜æ•ˆæœéªŒè¯å»ºè®®ï¼š

- ä½¿ç”¨ `--v=5` çº§åˆ«è¿è¡Œ `kube-scheduler`ï¼Œè¾“å‡ºè°ƒåº¦è¯¦ç»†æ—¥å¿—ã€‚

- è§‚å¯Ÿè°ƒåº¦å»¶è¿ŸæŒ‡æ ‡ï¼ˆSchedulingLatencySecondsï¼‰ï¼š
  
  - `framework_extension_point_duration_seconds`
  
  - `scheduler_scheduling_duration_seconds_bucket`

## ğŸ§© 1.3. æ‰©å±•è°ƒåº¦å™¨ï¼ˆScheduling Framework æ’ä»¶ï¼‰

Kubernetes æ”¯æŒé€šè¿‡è°ƒåº¦æ¡†æ¶æ’ä»¶æœºåˆ¶è‡ªå®šä¹‰è°ƒåº¦é€»è¾‘ã€‚

### âœ¨ ç¤ºä¾‹ï¼šå¿«é€Ÿ Filter æ’ä»¶

è‡ªå®šä¹‰è¿‡æ»¤æ’ä»¶ï¼Œå¯åªè¯„ä¼°éƒ¨åˆ†èŠ‚ç‚¹ï¼Œä»è€Œå‡å°‘è°ƒåº¦å»¶è¿Ÿï¼š

```go
func (f *FastFilterPlugin) Filter(...) *framework.Status {
  if strings.HasPrefix(node.Name, "compute-node-") {
    return framework.NewStatus(framework.Success)
  }
  return framework.NewStatus(framework.Unschedulable)
}
```


## ğŸ§  1.4. ä½¿ç”¨å¤šä¸ªè°ƒåº¦å™¨ï¼ˆè°ƒåº¦å™¨éš”ç¦»ï¼‰

å¹¶è¡Œéƒ¨ç½²å¤šä¸ªè°ƒåº¦å™¨è¿›ç¨‹ï¼š

```yaml
spec:
  schedulerName: batch-scheduler
```

æ¯ç±»å·¥ä½œè´Ÿè½½ä½¿ç”¨ä¸åŒè°ƒåº¦å™¨è¿›è¡Œå¤„ç†ï¼Œå®ç°å¹¶è¡Œè°ƒåº¦å’Œèµ„æºéš”ç¦»ã€‚


## ğŸ›  1.5. ä½¿ç”¨é«˜æ€§èƒ½è°ƒåº¦ç³»ç»Ÿ

### Koordinator

- æ”¯æŒæ‰¹é‡è°ƒåº¦ã€NUMA æ„ŸçŸ¥ã€QoS èµ„æºåˆ†çº§
- ä¸ Kubernetes è°ƒåº¦æ¡†æ¶å…¼å®¹ï¼Œéƒ¨ç½²ç®€å•

### Volcano

- é¢å‘å¤§è§„æ¨¡æ‰¹å¤„ç†ã€AI/MLã€HPC ä»»åŠ¡è°ƒåº¦
- æ”¯æŒæŠ¢å ã€ä»»åŠ¡ä¼˜å…ˆçº§ã€ä¾èµ–å…³ç³»ç­‰


## ğŸ“Š 1.6. ç›‘æ§ä¸éªŒè¯å»ºè®®

- ä½¿ç”¨ `kubectl get pods -w` å®æ—¶è§‚å¯Ÿ Pending çŠ¶æ€
- å…³æ³¨è°ƒåº¦äº‹ä»¶ `FailedScheduling`
- è·Ÿè¸ª API Server æŒ‡æ ‡ï¼šQPSã€å»¶è¿Ÿã€å†…å­˜å ç”¨
- éƒ¨ç½² Prometheus + Grafana è¿›è¡Œç³»ç»Ÿç›‘æ§ä¸å¯è§†åŒ–


## âœ… 1.7. æ€»ç»“å¯¹æ¯”

| ä¼˜åŒ–æ–¹å¼                   | æ•ˆæœ              |
| ---------------------- | --------------- |
| æ§åˆ¶ Pod åˆ›å»ºé€Ÿç‡            | é¿å…æ§åˆ¶é¢ç»„ä»¶è¿‡è½½       |
| æé«˜è°ƒåº¦å™¨å¹¶å‘åº¦               | æå‡æ¯ç§’è°ƒåº¦åå        |
| ç¼–å†™è°ƒåº¦å™¨æ’ä»¶                | é™ä½å•æ¬¡è°ƒåº¦å¤æ‚åº¦       |
| å¤šè°ƒåº¦å™¨æ¶æ„                 | å®ç°ä»»åŠ¡éš”ç¦»ä¸å¹¶è¡Œè°ƒåº¦     |
| ä½¿ç”¨ Koordinator/Volcano | é¢å‘ AI/æ‰¹å¤„ç†ç­‰é«˜è´Ÿè½½åœºæ™¯ |

---

# 2. Etcdä¼˜åŒ–

etcd æ˜¯ Kubernetes æ§åˆ¶å¹³é¢çš„æ ¸å¿ƒå­˜å‚¨å¼•æ“ï¼Œä¸€æ—¦åœ¨å¤§è§„æ¨¡ Pod åˆ›å»ºã€è°ƒåº¦è¿‡ç¨‹ä¸­å‡ºç° **å†™å…¥å»¶è¿Ÿå¢åŠ **ï¼Œä¼šç›´æ¥å½±å“ API Server æ€§èƒ½ï¼Œè¿›è€Œæ‹–æ…¢è°ƒåº¦å™¨å’Œæ§åˆ¶å™¨ååº”é€Ÿåº¦ï¼Œç”šè‡³å¼•å‘é›†ç¾¤ä¸å¯ç”¨ã€‚

## ğŸ”§ 2.1. åŸºç¡€é…ç½®ä¼˜åŒ–

### âœ… 1. å¯ç”¨è‡ªåŠ¨å‹ç¼©å†å²æ•°æ®

etcd é»˜è®¤ä¼šä¿ç•™å†å²ç‰ˆæœ¬ï¼Œéšç€å¯¹è±¡å˜åŒ–å¢å¤šï¼Œå­˜å‚¨è†¨èƒ€ï¼Œå¯¼è‡´å»¶è¿Ÿå‡é«˜ã€‚

```bash
--auto-compaction-retention=1h   # æ¯å°æ—¶æ¸…ç†å†å²
--snapshot-count=10000           # æ§åˆ¶ä½•æ—¶è§¦å‘å¿«ç…§
```

### âœ… 2. å¯ç”¨ WAL å‹ç¼©

å‹ç¼© Write-Ahead Logï¼Œå‡å°‘ç£ç›˜ I/O å¼€é”€ï¼š

```bash
--experimental-initial-corrupt-check=true
--experimental-compact-hash-check-enabled=true
```


## ğŸ’½ 2.2. ç¡¬ä»¶å±‚ä¼˜åŒ–ï¼ˆéå¸¸å…³é”®ï¼‰

etcd å¯¹ **ç£ç›˜ IOPS å’Œå»¶è¿Ÿ** æ•æ„Ÿï¼Œæ¨èï¼š

- **ä½¿ç”¨ SSD**ï¼ˆNVMe æœ€ä½³ï¼‰

- etcd ç‹¬ç«‹ç£ç›˜ï¼Œé¿å…å’Œ kubelet æˆ– container runtime å…±ç”¨

- æå‡å†…å­˜ï¼ˆå»ºè®® 16G+ï¼‰ã€CPU æ€§èƒ½ï¼ˆè‡³å°‘ 4 æ ¸ï¼‰

- å¼€å¯ NUMA äº²å’Œé…ç½®ï¼Œå‡å°‘è·¨æ ¸è°ƒåº¦


## ğŸ§± 2.3. é›†ç¾¤éƒ¨ç½²æ¶æ„ä¼˜åŒ–

### âœ… 1. éš”ç¦»éƒ¨ç½² etcd

etcdä¸è¦ä¸ `kube-apiserver`ã€`controller-manager` ç­‰ç»„ä»¶å…±èŠ‚ç‚¹è¿è¡Œã€‚

1ï¼‰**etcd å¯¹ç£ç›˜ IOã€å†…å­˜å’Œ CPU çš„æ€§èƒ½éå¸¸æ•æ„Ÿ**ï¼Œç‰¹åˆ«æ˜¯ç£ç›˜å»¶è¿Ÿå¯¹ etcd æ€§èƒ½å’Œç¨³å®šæ€§æœ‰æ˜¾è‘—å½±å“ã€‚

- kube-apiserverã€controller-managerã€scheduler ç­‰ç»„ä»¶ä¹Ÿä¼šé¢‘ç¹è®¿é—® etcdï¼Œäº§ç”Ÿè¾ƒå¤§ CPU å’Œå†…å­˜è´Ÿè½½ã€‚

- å¦‚æœå®ƒä»¬éƒ¨ç½²åœ¨åŒä¸€èŠ‚ç‚¹ï¼Œå®¹æ˜“å¯¼è‡´ **èµ„æºç«äº‰ï¼ˆå°¤å…¶æ˜¯ IOï¼‰**ï¼Œå½±å“ etcd çš„å“åº”èƒ½åŠ›å’Œç¨³å®šæ€§ï¼Œè¿›è€Œå½±å“æ•´ä¸ªé›†ç¾¤çš„æ§åˆ¶é¢ã€‚

2ï¼‰ **Kubernetes é€šå¸¸è¿è¡Œåœ¨é«˜é€Ÿå±€åŸŸç½‘å†…ï¼Œè®¿é—® etcd çš„å»¶è¿Ÿå¾ˆå°**

- ç½‘ç»œå»¶è¿Ÿåœ¨ç°ä»£æ•°æ®ä¸­å¿ƒæˆ–äº‘ç¯å¢ƒä¸­é€šå¸¸æ˜¯**å¾®ç§’åˆ°æ¯«ç§’çº§åˆ«**ã€‚

- åªè¦ä¿è¯ etcd é›†ç¾¤ç½‘ç»œç¨³å®šï¼Œæ§åˆ¶é¢ç»„ä»¶å³ä½¿ä¸åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¹Ÿèƒ½å¿«é€Ÿè®¿é—®ã€‚

3ï¼‰ **ä¸åœ¨ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¯ä»¥é¿å…â€œå±€éƒ¨é«˜è´Ÿè½½â€å¯¼è‡´è¿é”å½±å“**

- å¦‚æœ kube-apiserver è·Ÿ etcd åŒèŠ‚ç‚¹ï¼Œä¸€æ—¦ kube-apiserver çªå‘æµé‡ï¼ˆæ¯”å¦‚åˆ›å»ºå¤§é‡èµ„æºï¼‰ï¼Œä¼šå¯¼è‡´ **etcd æ‰€åœ¨èŠ‚ç‚¹èµ„æºè¢«å æ»¡**ï¼Œä»è€Œå½±å“ etcd å“åº”ã€‚

- åä¹‹äº¦ç„¶ï¼Œetcd çš„ GC æˆ– compaction æ“ä½œä¹Ÿå¯èƒ½å½±å“ apiserver çš„æ€§èƒ½ã€‚

### âœ… 2. å¤šå‰¯æœ¬éƒ¨ç½²ï¼ˆ3~5ä¸ªèŠ‚ç‚¹ï¼‰

é¿å…å•ç‚¹ç“¶é¢ˆï¼Œå¹¶å¯ç”¨é«˜å¯ç”¨ã€‚

# 3. kube-apiserverä¼˜åŒ–

åœ¨å¤§é‡ Pod åŒæ—¶è°ƒåº¦æ—¶ï¼Œ**API Server å‹åŠ›å¤§** æ˜¯é€ æˆé›†ç¾¤å¡é¡¿æˆ–å¼‚å¸¸çš„æ ¸å¿ƒç“¶é¢ˆä¹‹ä¸€ï¼Œä¸»è¦è¡¨ç°ä¸ºï¼š

- åˆ›å»ºã€æ›´æ–°ã€æŸ¥è¯¢ Pod ç­‰è¯·æ±‚å“åº”å˜æ…¢

- kubeletã€controller-manager ä¸ API Server é€šä¿¡è¶…æ—¶

- etcd QPS æ¿€å¢ã€å»¶è¿Ÿå‡é«˜ï¼Œç”šè‡³è§¦å‘ç†”æ–­

ä»¥ä¸‹æ˜¯å…·ä½“çš„ä¼˜åŒ–ç­–ç•¥ï¼Œä»é›†ç¾¤å‚æ•°ã€é™æµã€ç»„ä»¶è§£è€¦ç­‰å¤šä¸ªå±‚é¢å±•å¼€ï¼š

## ğŸ§± 3.1. æ§åˆ¶è¯·æ±‚é€Ÿç‡ï¼ˆé™æµï¼‰

### âœ… 1. æ§åˆ¶å®¢æˆ·ç«¯åˆ›å»ºé€Ÿç‡

æ¯”å¦‚å¤§é‡ Job/Deployment æ§åˆ¶å™¨ã€è„šæœ¬åŒæ—¶å‘å‡º `kubectl apply` è¯·æ±‚ï¼š

**è§£å†³æ–¹æ³•ï¼š**

- é‡‡ç”¨ `kubectl --wait=false` å¼‚æ­¥åˆ›å»º

- ä½¿ç”¨åˆ†æ‰¹ apply æˆ– sleep æ§åˆ¶é€Ÿç‡

- ä½¿ç”¨ controllerï¼ˆä¾‹å¦‚è‡ªå®šä¹‰ CRD + controllerï¼‰åˆ†æ‰¹åˆ†ç»„ç®¡ç† pod/job


## âš™ï¸ 3.2. è°ƒä¼˜ API Server å‚æ•°

åœ¨ kube-apiserver å¯åŠ¨å‚æ•°ä¸­ï¼š

### âœ… 1. å¢åŠ æœ€å¤§å¹¶å‘ QPS

```bash
--max-requests-inflight=4000              # é»˜è®¤ 400ï¼Œå¢åŠ ååèƒ½åŠ›
--max-mutating-requests-inflight=2000     # é»˜è®¤ 200ï¼Œè°ƒå¤§å†™è¯·æ±‚å®¹é‡
```

### âœ… 2. å¢åŠ ç¼“å­˜æ—¶é—´ä¸å“åº”çª—å£

```bash
--request-timeout=1m
--min-request-timeout=300
```

## 3.3. operatorä¼˜åŒ–

å¦‚æœæœ‰å¼€å‘è‡ªå®šä¹‰çš„operatorï¼Œåˆ™éœ€è¦å¯¹operatorçš„é€»è¾‘è¿›è¡Œä¼˜åŒ–ã€‚

### âœ… 1. ä½¿ç”¨ informer ç¼“å­˜æœºåˆ¶ï¼ˆclient-go é»˜è®¤æ”¯æŒï¼‰

è‡ªå®šä¹‰æ§åˆ¶å™¨æˆ–è°ƒåº¦æ’ä»¶ä¸­åº”ä½¿ç”¨å…±äº«ç¼“å­˜ï¼Œè€Œéé¢‘ç¹ `GET`ï¼š

```bash
informer := factory.Core().V1().Pods().Informer()
```

### âœ… 2. å‡å°‘ä¸å¿…è¦çš„ Watch æˆ–é¢‘ç¹ List è¯·æ±‚

- è°ƒåº¦å™¨æ’ä»¶ä¸­ä¸è¦é¢‘ç¹è®¿é—® Pod åˆ—è¡¨

- å‡å°‘ metrics æˆ–å®¡è®¡æ—¥å¿—ç³»ç»Ÿå¯¹ API çš„é«˜é¢‘é‡‡é›†

# 4. ç½‘ç»œæ’ä»¶ä¼˜åŒ–

Kubernetes ç½‘ç»œæ’ä»¶ï¼ˆCNIï¼‰åœ¨å¤§è§„æ¨¡éƒ¨ç½²æˆ–é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œè‹¥å¤„ç†èƒ½åŠ›è·Ÿä¸ä¸Šï¼Œä¼šå‡ºç° **è°ƒåº¦æˆåŠŸä½†ç½‘ç»œä¸é€šã€æœåŠ¡è¿æ¥æ…¢ã€è·¨èŠ‚ç‚¹é€šä¿¡å¼‚å¸¸** ç­‰é—®é¢˜ã€‚

## ğŸ§­ 4.1. ç½‘ç»œç“¶é¢ˆè¡¨ç°

| ç°è±¡                            | å¯èƒ½åŸå›                           |
| ----------------------------- | ----------------------------- |
| Pod åˆ›å»ºå¡ä½åœ¨ `ContainerCreating` | CNI æ’ä»¶è°ƒç”¨è¶…æ—¶ï¼Œç½‘ç»œè®¾å¤‡æœªåˆå§‹åŒ–           |
| è·¨èŠ‚ç‚¹æœåŠ¡è®¿é—®æ…¢æˆ–è¶…æ—¶                   | ç½‘ç»œæ’ä»¶è½¬å‘è·¯å¾„æ€§èƒ½ä¸è¶³ï¼Œiptables/ebpf ç´¯ç§¯ |
| é›†ç¾¤ä¸­ ping æŸäº› Pod æ…¢             | æŸäº›èŠ‚ç‚¹æµé‡ç“¶é¢ˆï¼Œæˆ–è€… VXLAN éš§é“é«˜å»¶è¿Ÿ       |
| `kube-proxy` CPU å æ»¡           | iptables è§„åˆ™è¿‡å¤šæˆ–é¢‘ç¹å˜æ›´            |

## âœ… 4.2. é€‰å‹ä¼˜åŒ–ï¼šé€‰æ‹©é«˜æ€§èƒ½ CNI æ’ä»¶

| æ’ä»¶                          | æ€§èƒ½ç‰¹ç‚¹                             |
| --------------------------- | -------------------------------- |
| [Cilium](https://cilium.io) | eBPF é©±åŠ¨ï¼Œæ— éœ€ iptablesï¼Œæé«˜æ€§èƒ½ï¼Œæ”¯æŒå¤§è§„æ¨¡èŠ‚ç‚¹ |
| Calico (BPF æ¨¡å¼)             | æ”¯æŒ eBPF æ¨¡å¼ï¼Œæ€§èƒ½æ›´å¥½äºä¼ ç»Ÿ iptables      |
| Flannel                     | é€‚ç”¨äºå°è§„æ¨¡é›†ç¾¤ï¼Œæ€§èƒ½æ™®é€šï¼Œä¸æ¨èå¤§é›†ç¾¤ä½¿ç”¨           |
| Multus                      | æ”¯æŒå¤šç½‘å¡/å¤š CNIï¼Œé€‚åˆè¾¹ç¼˜åœºæ™¯ä½†è°ƒè¯•å¤æ‚          |

> ğŸ’¡ æ¨èä½¿ç”¨ **Cilium æˆ– Calicoï¼ˆeBPF æ¨¡å¼ï¼‰**ï¼Œé¿å…ä½¿ç”¨ä¼ ç»Ÿ Flannel/VXLANã€‚

## âš™ï¸ 4.3. ç½‘ç»œæ’ä»¶å‚æ•°è°ƒä¼˜

### ğŸ”¹ Cilium ç¤ºä¾‹

é…ç½® `/etc/cilium/cilium-config`ï¼š

```bash
enable-bpf-masquerade: "true"
enable-ipv4-masquerade: "false"
bpf-lb-map-max: "65536"
bpf-ct-global-tcp-max: "524288"
bpf-ct-global-any-max: "262144"
```

å¹¶å¯ç”¨ kube-proxy æ›¿ä»£æ¨¡å¼ï¼ˆkube-proxy-freeï¼‰ï¼š

```yaml
kubeProxyReplacement: "strict"
```


## ğŸ”„ 4.4. è·¨èŠ‚ç‚¹é€šä¿¡ä¼˜åŒ–

### âœ… 1. å‡å°‘ VXLAN å°è£…ï¼ˆæˆ–æ”¹ä¸º Native Routingï¼‰

- Flannel/Calico VXLAN æ¨¡å¼æ€§èƒ½å·®

- æ¨èåˆ‡æ¢ä¸º Calico çš„ **BGP æ¨¡å¼**ï¼ˆè·¯ç”±ç›´è¾¾ï¼Œæ— å°è£…ï¼‰

### âœ… 2. ä½¿ç”¨ Direct Server Returnï¼ˆDSRï¼‰+ ECMP è·¯ç”±

å¤§æµé‡æœåŠ¡éƒ¨ç½²æ—¶ï¼Œé¿å…ä¸­å¿ƒåŒ–è½¬å‘ã€‚

## ğŸ”ƒ 4.5. kube-proxy ä¼˜åŒ–

### âœ… 1. ä½¿ç”¨ `ipvs` æ¨¡å¼ä»£æ›¿ `iptables`

```bash
--proxy-mode=ipvs
--ipvs-scheduler=rr
```

ç›¸æ¯” `iptables`ï¼Œ`ipvs` å¤„ç†æœåŠ¡è½¬å‘åœ¨å¤§è§„æ¨¡é›†ç¾¤ä¸‹ CPU æ›´çœã€å»¶è¿Ÿæ›´ä½ã€‚

### âœ… 2. é…åˆ eBPF æ›¿ä»£ kube-proxyï¼ˆCilium æ¨èï¼‰

Cilium çš„ `kube-proxy-replacement=strict` ç›´æ¥ä½¿ç”¨ BPF åŠ é€ŸæœåŠ¡è°ƒåº¦ã€‚

## ğŸ”§ 4.6. èŠ‚ç‚¹ç³»ç»Ÿå‚æ•°ä¼˜åŒ–

è®¾ç½®èŠ‚ç‚¹çš„å†…æ ¸å‚æ•°ï¼Œæå‡å¤§æµé‡ä¸‹ç³»ç»Ÿå¤„ç†èƒ½åŠ›ï¼š

```bash
# æé«˜ conntrack è¡¨å®¹é‡
sysctl -w net.netfilter.nf_conntrack_max=262144
sysctl -w net.netfilter.nf_conntrack_tcp_timeout_established=86400

# å…è®¸æ›´å¤šæ–‡ä»¶æè¿°ç¬¦
ulimit -n 1048576

# è°ƒé«˜é˜Ÿåˆ—é•¿åº¦
sysctl -w net.core.somaxconn=1024
sysctl -w net.core.netdev_max_backlog=250000
```

## ğŸ“Š 4.7. ç›‘æ§å…³é”®æŒ‡æ ‡

é€šè¿‡ Cilium/Calico è‡ªå¸¦ metrics æˆ– Prometheus é‡‡é›†ï¼š

| æŒ‡æ ‡                                  | è¯´æ˜               |
| ----------------------------------- | ---------------- |
| `cilium_forwarding_latency_seconds` | è½¬å‘å»¶è¿Ÿ             |
| `cilium_drop_count_total`           | æ•°æ®åŒ…è¢«ä¸¢å¼ƒçš„åŸå›         |
| `iptables_rule_count`               | kube-proxy ä¸­è§„åˆ™æ•°é‡ |
| `conntrack_entries`                 | å½“å‰è¿æ¥è·Ÿè¸ªè¡¨å¤§å°        |

## âœ… 4.8. æ€»ç»“ä¼˜åŒ–å»ºè®®è¡¨

| æ–¹å‘   | æ–¹æ¡ˆ                               |
| ---- | -------------------------------- |
| æ’ä»¶é€‰å‹ | ä½¿ç”¨ Cilium/Calico eBPFï¼Œé¿å… Flannel |
| æ’ä»¶é…ç½® | ä¼˜åŒ–è½¬å‘è¡¨ã€è¿æ¥è·Ÿè¸ªè¡¨å¤§å°                    |
| ç½‘ç»œæ¶æ„ | BGP æ›¿ä»£ VXLANï¼Œå¼€å¯ kube-proxy-free  |
| ç³»ç»Ÿå†…æ ¸ | è°ƒé«˜ conntrack / backlog ç­‰å‚æ•°       |
| è½¬å‘æ¨¡å¼ | ä½¿ç”¨ ipvs æˆ– eBPF åŠ é€Ÿ kube-proxy     |
| ç›‘æ§æ’æŸ¥ | å¼€å¯ drop åˆ†æã€BPF è·¯å¾„è¿½è¸ª              |

---

# 5. æ€»ç»“

å¤§è§„æ¨¡ Pod è°ƒåº¦ä¸ä»…ä»…æ˜¯è¿½æ±‚é€Ÿåº¦ï¼Œæ›´é‡è¦çš„æ˜¯åœ¨é«˜å‹ä¸‹ä¿æŒç³»ç»Ÿçš„ç¨³å®šæ€§ä¸æ­£ç¡®æ€§ã€‚éœ€è¦ä»å„ä¸ªæ–¹é¢è¿›è¡Œé›†ç¾¤ä¼˜åŒ–æ‰èƒ½æ‰¿å—å¤§è§„æ¨¡podé›†ç¾¤çš„æ€§èƒ½å‹åŠ›ã€‚æœ¬æ–‡åˆ†åˆ«ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢è¿›è¡Œä¼˜åŒ–ï¼š

- è°ƒåº¦å™¨åŠæ‰©å±•è°ƒåº¦å™¨

- ETCDä¼˜åŒ–

- kube-apiserverä¼˜åŒ–

- ç½‘ç»œæ’ä»¶åŠèŠ‚ç‚¹ä¼˜åŒ–

åªè¦è®¾è®¡åˆç†ï¼ŒKubernetes å®Œå…¨å¯ä»¥ç¨³å®šé«˜æ•ˆåœ°è°ƒåº¦æ•°ä¸‡ä¸ª Podã€‚
